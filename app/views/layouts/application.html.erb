<!DOCTYPE html>
<html>
  <script>
    // Apply saved theme before paint to prevent flash
    if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
  </script>
  <head>
    <title><%= content_for(:title) || "Contacts" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%# CSP not enforced — inline up-on-* callbacks work without up.safe_callback %>
    <%#= csp_meta_tag %>

    <link rel="icon" href="/icon.png" type="image/png">

    <%# Google Fonts — DM Sans for body, Instrument Serif for display %>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">

    <%# Tailwind CSS via Play CDN %>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"DM Sans"', 'system-ui', 'sans-serif'],
              display: ['"Instrument Serif"', 'Georgia', 'serif'],
            },
            colors: {
              sidebar: {
                DEFAULT: '#1a1d23',
                light: '#22252d',
                lighter: '#2a2e37',
                border: '#32363f',
              },
              accent: {
                DEFAULT: '#d4976a',
                light: '#e4b08a',
                dark: '#b47a50',
                faint: 'rgba(212, 151, 106, 0.1)',
                subtle: 'rgba(212, 151, 106, 0.15)',
              },
              surface: {
                DEFAULT: '#faf9f7',
                raised: '#ffffff',
                muted: '#f2f0ec',
              },
            },
          },
        },
      }
    </script>

    <%# Unpoly CSS (no /dist/ — correct path for the npm package) %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/unpoly@3.12.1/unpoly.min.css">

    <%# Unpoly JS — loaded as blocking IIFE before importmap modules so window.up is ready %>
    <script src="https://cdn.jsdelivr.net/npm/unpoly@3.12.1/unpoly.min.js"></script>

    <%# Application JS via importmap (configures Unpoly, defines previews) %>
    <%= javascript_importmap_tags %>

    <style>
      /* ---- Layout ---- */
      .app-shell {
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      #contacts-sidebar {
        width: 340px;
        min-width: 280px;
        flex-shrink: 0;
        overflow-y: auto;
        background: #1a1d23;
        display: flex;
        flex-direction: column;
      }
      #contacts-sidebar::-webkit-scrollbar { width: 4px; }
      #contacts-sidebar::-webkit-scrollbar-track { background: transparent; }
      #contacts-sidebar::-webkit-scrollbar-thumb { background: #32363f; border-radius: 2px; }

      #contacts-list {
        display: flex;
        flex-direction: column;
      }
      #contacts-list::-webkit-scrollbar { width: 4px; }
      #contacts-list::-webkit-scrollbar-track { background: transparent; }
      #contacts-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 2px; }
      #contacts-list::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
      #contact-detail {
        flex: 1;
        overflow-y: auto;
        background: #faf9f7;
      }
      #contact-detail::-webkit-scrollbar { width: 6px; }
      #contact-detail::-webkit-scrollbar-track { background: transparent; }
      #contact-detail::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }

      /* ---- Contact rows ---- */
      .contact-row {
        border-left: 3px solid transparent;
        transition: all 0.15s ease;
      }
      .contact-row:hover {
        background: rgba(255,255,255,0.04);
        border-left-color: rgba(212, 151, 106, 0.4);
      }
      .contact-row.up-active,
      .contact-row:has(.up-active) {
        background: rgba(212, 151, 106, 0.08);
        border-left-color: #d4976a;
      }
      .contact-row.selected {
        background: rgba(212, 151, 106, 0.1);
        border-left-color: #d4976a;
      }

      /* ---- Loading state ---- */
      .up-loading {
        opacity: 0.5;
        transition: opacity 0.15s ease;
      }

      /* ---- Star states ---- */
      .star-icon.starred { color: #d4976a; }
      .star-icon.unstarred { color: #9ca3af; }

      /* ---- Unpoly progress bar ---- */
      up-progress-bar {
        background: #d4976a !important;
      }

      /* ---- Overlay styling ---- */
      up-modal-viewport {
        backdrop-filter: blur(8px);
        background: rgba(26, 29, 35, 0.6) !important;
      }
      up-modal-box {
        border-radius: 1rem;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.05), 0 25px 60px -12px rgba(0,0,0,0.35);
        max-width: 540px;
        width: calc(100vw - 3rem);
        padding: 0;
        overflow: hidden;
        background: #fff;
      }
      up-drawer-box {
        max-width: 480px;
        box-shadow: -10px 0 40px rgba(0,0,0,0.2);
      }

      /* ---- Flash toast animation ---- */
      @keyframes flash-in {
        from { transform: translateY(-100%); opacity: 0; }
        to   { transform: translateY(0); opacity: 1; }
      }
      @keyframes flash-out {
        from { transform: translateY(0); opacity: 1; }
        to   { transform: translateY(-100%); opacity: 0; }
      }
      .flash-toast {
        animation: flash-in 0.3s ease-out;
      }
      .flash-toast.removing {
        animation: flash-out 0.3s ease-in forwards;
      }

      /* ---- Activity timeline line ---- */
      .activity-item {
        position: relative;
        padding-left: 2.25rem;
      }
      .activity-item::before {
        content: '';
        position: absolute;
        left: 0.6875rem;
        top: 1.75rem;
        bottom: -0.75rem;
        width: 1px;
        background: #e5e2dd;
      }
      .activity-item:last-child::before {
        display: none;
      }
      .activity-dot {
        position: absolute;
        left: 0;
        top: 0.125rem;
        width: 1.375rem;
        height: 1.375rem;
        border-radius: 50%;
        background: #d4976a;
        border: 2px solid #faf9f7;
      }

      /* ---- Sidebar search input ---- */
      .sidebar-search {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.08);
        color: #e5e7eb;
        transition: all 0.2s ease;
      }
      .sidebar-search::placeholder {
        color: #6b7280;
      }
      .sidebar-search:focus {
        background: rgba(255,255,255,0.1);
        border-color: rgba(212, 151, 106, 0.4);
        outline: none;
        box-shadow: 0 0 0 2px rgba(212, 151, 106, 0.15);
      }

      /* ---- Filter pill styling ---- */
      .filter-pill {
        transition: all 0.15s ease;
      }
      .filter-pill.active {
        background: #d4976a;
        color: #fff;
      }
      .filter-pill:not(.active) {
        color: #9ca3af;
      }
      .filter-pill:not(.active):hover {
        color: #d1d5db;
        background: rgba(255,255,255,0.06);
      }

      /* ---- Form focus ring ---- */
      .form-input:focus {
        outline: none;
        border-color: #d4976a;
        box-shadow: 0 0 0 2px rgba(212, 151, 106, 0.2);
      }

      /* ---- Tag badges in detail view ---- */
      .tag-badge {
        backdrop-filter: blur(4px);
      }

      /* ---- Dark mode ---- */
      html.dark #contact-detail { background: #1e2128; color: #e5e7eb; }
      html.dark .bg-surface-raised, html.dark .bg-white { background: #252830 !important; }
      html.dark .form-input { background: #2a2f38; border-color: #3a4050; color: #e5e7eb; }
      html.dark up-modal-box { background: #1e2128; }
      html.dark up-drawer-box { background: #1e2128; }
      html.dark .text-gray-900 { color: #f3f4f6 !important; }
      html.dark .text-gray-600, html.dark .text-gray-700 { color: #9ca3af !important; }
      html.dark .text-gray-400 { color: #6b7280 !important; }
      html.dark .text-gray-500 { color: #8b95a5 !important; }
      html.dark .border-gray-200\/60, html.dark .border-gray-200 { border-color: #3a4050 !important; }
      html.dark .bg-surface-muted { background: #2a2f38 !important; }
      html.dark .bg-surface { background: #1e2128 !important; }
      html.dark .bg-amber-50 { background: #342a1a !important; }
      html.dark .border-amber-200\/60 { border-color: #5a4520 !important; }
      html.dark .text-amber-700 { color: #d4976a !important; }
      html.dark .hover\:bg-black\/5:hover { background: rgba(255,255,255,0.06) !important; }
      html.dark .hover\:bg-red-50:hover { background: rgba(220,38,38,0.1) !important; }
      html.dark #contact-detail::-webkit-scrollbar-thumb { background: #3a4050; }
      html.dark .activity-item::before { background: #3a4050; }
      html.dark .activity-dot { border-color: #1e2128; }

      /* Dark mode theme toggle button */
      .theme-toggle {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.08);
        color: #9ca3af;
        transition: all 0.2s ease;
        cursor: pointer;
      }
      .theme-toggle:hover {
        background: rgba(255,255,255,0.1);
        color: #e5e7eb;
      }
      /* Show moon by default (light mode), sun in dark mode */
      .theme-toggle .moon-icon { display: block; }
      .theme-toggle .sun-icon { display: none; }
      html.dark .theme-toggle .moon-icon { display: none; }
      html.dark .theme-toggle .sun-icon { display: block; }

      /* Overlay style toggle pill (modal / drawer) */
      .overlay-toggle-pill {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.08);
        color: #9ca3af;
        cursor: pointer;
        line-height: 1;
      }
      .overlay-toggle-pill:hover {
        background: rgba(255,255,255,0.1);
        color: #e5e7eb;
      }
      .overlay-toggle-pill .overlay-toggle-label::after {
        content: 'Modal';
      }
      .overlay-toggle-pill[data-current="drawer"] .overlay-toggle-label::after {
        content: 'Drawer';
      }
    </style>
  </head>

  <body class="bg-surface font-sans text-gray-800 text-sm antialiased">
    <%# Progress bar — shown during navigation %>
    <up-progress-bar></up-progress-bar>

    <%# Flash messages — up-hungry keeps them updated across fragment swaps %>
    <%= render 'shared/flash' %>

    <%# Two-panel shell — full height, no top nav bar for maximum space %>
    <div class="app-shell">
      <%= yield %>
    </div>
  </body>
</html>
