<!DOCTYPE html>
<html>
  <script>
    // Apply saved theme before paint to prevent flash.
    // Defaults to 'system' (follows prefers-color-scheme) when no preference stored.
    (function() {
      var t = localStorage.getItem('theme') || 'system';
      if (t === 'dark' || (t === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>
  <head>
    <title><%= content_for(:title) || "Contacts" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%# CSP not enforced — inline up-on-* callbacks work without up.safe_callback %>
    <%#= csp_meta_tag %>

    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Google Fonts — DM Sans for body, Instrument Serif for display %>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">

    <%# Tailwind CSS via Play CDN %>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"DM Sans"', 'system-ui', 'sans-serif'],
              display: ['"Instrument Serif"', 'Georgia', 'serif'],
            },
            colors: {
              sidebar: {
                DEFAULT: '#d8d0c5',
                light: '#e0d9ce',
                lighter: '#e8e2d8',
                border: '#c8c0b5',
              },
              accent: {
                DEFAULT: '#d4976a',
                light: '#e4b08a',
                dark: '#b47a50',
                faint: 'rgba(212, 151, 106, 0.1)',
                subtle: 'rgba(212, 151, 106, 0.15)',
              },
              surface: {
                DEFAULT: '#ede8df',
                raised: '#f5f0e8',
                muted: '#e4ddd3',
              },
            },
          },
        },
      }
    </script>

    <%# Unpoly CSS (no /dist/ — correct path for the npm package) %>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/unpoly@3.12.1/unpoly.min.css">

    <%# Unpoly JS — loaded as blocking IIFE before importmap modules so window.up is ready %>
    <script src="https://cdn.jsdelivr.net/npm/unpoly@3.12.1/unpoly.min.js"></script>

    <%# Application JS via importmap (configures Unpoly, defines previews) %>
    <%= javascript_importmap_tags %>

    <style>
      /* ---- Layout ---- */
      .app-shell {
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      #contacts-sidebar {
        width: 340px;
        min-width: 280px;
        flex-shrink: 0;
        overflow-y: auto;
        background: #d8d0c5;
        display: flex;
        flex-direction: column;
      }
      #contacts-sidebar::-webkit-scrollbar { width: 4px; }
      #contacts-sidebar::-webkit-scrollbar-track { background: transparent; }
      #contacts-sidebar::-webkit-scrollbar-thumb { background: #bdb5aa; border-radius: 2px; }

      #contacts-list {
        display: flex;
        flex-direction: column;
      }
      #contacts-list::-webkit-scrollbar { width: 4px; }
      #contacts-list::-webkit-scrollbar-track { background: transparent; }
      #contacts-list::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.18); border-radius: 2px; }
      #contacts-list::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.28); }
      #contact-detail {
        flex: 1;
        overflow-y: auto;
        background: #ede8df;
      }
      #contact-detail::-webkit-scrollbar { width: 6px; }
      #contact-detail::-webkit-scrollbar-track { background: transparent; }
      #contact-detail::-webkit-scrollbar-thumb { background: #c9c2b8; border-radius: 3px; }

      /* ---- Contact rows ---- */
      .contact-row {
        border-left: 3px solid transparent;
        transition: all 0.15s ease;
      }
      .contact-row:hover {
        background: rgba(0,0,0,0.05);
        border-left-color: rgba(212, 151, 106, 0.5);
      }
      .contact-row.up-active,
      .contact-row:has(.up-active) {
        background: rgba(212, 151, 106, 0.18);
        border-left-color: #d4976a;
      }
      .contact-row.up-current {
        background: rgba(212, 151, 106, 0.18);
        border-left-color: #d4976a;
      }

      /* ---- Loading state ---- */
      .up-loading {
        opacity: 0.5;
        transition: opacity 0.15s ease;
      }

      /* ---- Star states ---- */
      .star-icon.starred { color: #d4976a; }
      .star-icon.unstarred { color: #6b7280; }

      /* ---- Unpoly progress bar ---- */
      up-progress-bar {
        background: #d4976a !important;
      }

      /* ---- Overlay styling ---- */
      up-modal-viewport {
        backdrop-filter: blur(8px);
        background: rgba(26, 29, 35, 0.6) !important;
      }
      up-modal-box {
        border-radius: 1rem;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.05), 0 25px 60px -12px rgba(0,0,0,0.35);
        max-width: 540px;
        width: calc(100vw - 3rem);
        padding: 0;
        overflow: hidden;
        background: #f5f0e8;
      }
      up-drawer-box {
        max-width: 560px;
        box-shadow: -10px 0 40px rgba(0,0,0,0.2);
      }

      /* ---- Flash toast animation ---- */
      @keyframes flash-in {
        from { transform: translateY(-100%); opacity: 0; }
        to   { transform: translateY(0); opacity: 1; }
      }
      @keyframes flash-out {
        from { transform: translateY(0); opacity: 1; }
        to   { transform: translateY(-100%); opacity: 0; }
      }
      .flash-toast {
        animation: flash-in 0.3s ease-out;
      }
      .flash-toast.removing {
        animation: flash-out 0.3s ease-in forwards;
      }

      /* ---- Activity timeline line ---- */
      .activity-item {
        position: relative;
        padding-left: 2.25rem;
      }
      .activity-item::before {
        content: '';
        position: absolute;
        left: 0.6875rem;
        top: 1.75rem;
        bottom: -0.75rem;
        width: 1px;
        background: #d5cfc6;
      }
      .activity-item:last-child::before {
        display: none;
      }
      .activity-dot {
        position: absolute;
        left: 0;
        top: 0.125rem;
        width: 1.375rem;
        height: 1.375rem;
        border-radius: 50%;
        background: #d4976a;
        border: 2px solid #ede8df;
      }

      /* ---- Sidebar search input ---- */
      .sidebar-search {
        background: rgba(255,255,255,0.5);
        border: 1px solid rgba(0,0,0,0.1);
        color: #374151;
        transition: all 0.2s ease;
      }
      .sidebar-search::placeholder {
        color: #9ca3af;
      }
      .sidebar-search:focus {
        background: rgba(255,255,255,0.75);
        border-color: rgba(212, 151, 106, 0.5);
        outline: none;
        box-shadow: 0 0 0 2px rgba(212, 151, 106, 0.15);
      }

      /* ---- Filter pill styling ---- */
      .filter-pill {
        transition: all 0.15s ease;
      }
      .filter-pill.active {
        background: #d4976a;
        color: #fff;
      }
      .filter-pill:not(.active) {
        color: #6b7280;
      }
      .filter-pill:not(.active):hover {
        color: #374151;
        background: rgba(0,0,0,0.07);
      }

      /* ---- Tag picker ---- */
      .tag-picker-item .tag-pill {
        transition: opacity 0.15s ease, box-shadow 0.15s ease;
      }
      .tag-picker-item:has(input:not(:checked)) .tag-pill {
        opacity: 0.28;
      }
      .tag-picker-item:has(input:not(:checked)):hover .tag-pill {
        opacity: 0.6;
      }
      .tag-picker-item:has(input:checked) .tag-pill {
        box-shadow: 0 0 0 2px #fff, 0 0 0 3.5px currentColor;
      }

      /* ---- Form focus ring ---- */
      .form-input:focus {
        outline: none;
        border-color: #d4976a;
        box-shadow: 0 0 0 2px rgba(212, 151, 106, 0.2);
      }

      /* ---- Tag badges in detail view ---- */
      .tag-badge {
        backdrop-filter: blur(4px);
      }

      /* ---- Dark mode ---- */
      html.dark #contacts-sidebar { background: #1a1d23; }
      html.dark #contacts-sidebar::-webkit-scrollbar-thumb { background: #32363f; }
      html.dark .border-sidebar-border { border-color: #32363f !important; }
      html.dark #contacts-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); }
      html.dark #contacts-list::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
      html.dark .contact-row:hover { background: rgba(255,255,255,0.04); }
      html.dark .contact-row.up-active, html.dark .contact-row:has(.up-active) { background: rgba(212,151,106,0.08); }
      html.dark .contact-row.up-current { background: rgba(212,151,106,0.1); }
      html.dark .contact-name { color: #e2ddd6 !important; }
      html.dark .contact-company { color: #6b7280 !important; }
      html.dark .sidebar-search { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.08); color: #e5e7eb; }
      html.dark .sidebar-search:focus { background: rgba(255,255,255,0.1); border-color: rgba(212,151,106,0.4); }
      html.dark .filter-pill:not(.active) { color: #9ca3af; }
      html.dark .filter-pill:not(.active):hover { color: #d1d5db; background: rgba(255,255,255,0.06); }
      html.dark .sidebar-title { color: #f3f4f6; }
      html.dark .sidebar-icon-btn { color: #9ca3af; }
      html.dark .sidebar-icon-btn:hover { color: #e5e7eb; background: rgba(255,255,255,0.08); }
      html.dark #contact-detail { background: #1e2128; color: #e5e7eb; }
      html.dark .bg-surface-raised, html.dark .bg-white { background: #252830 !important; }
      html.dark .form-input { background: #2a2f38; border-color: #3a4050; color: #e5e7eb; }
      html.dark up-modal-box { background: #1e2128; }
      html.dark up-drawer-box { background: #1e2128; }
      html.dark .text-gray-900 { color: #f3f4f6 !important; }
      html.dark .text-gray-600, html.dark .text-gray-700 { color: #9ca3af !important; }
      html.dark .text-gray-400 { color: #6b7280 !important; }
      html.dark .text-gray-500 { color: #8b95a5 !important; }
      html.dark .border-gray-200\/60, html.dark .border-gray-200 { border-color: #3a4050 !important; }
      html.dark .bg-surface-muted { background: #2a2f38 !important; }
      html.dark .bg-surface { background: #1e2128 !important; }
      html.dark .bg-amber-50 { background: #342a1a !important; }
      html.dark .border-amber-200\/60 { border-color: #5a4520 !important; }
      html.dark .text-amber-700 { color: #d4976a !important; }
      html.dark .hover\:bg-black\/5:hover { background: rgba(255,255,255,0.06) !important; }
      html.dark .hover\:bg-red-50:hover { background: rgba(220,38,38,0.1) !important; }
      html.dark #contact-detail::-webkit-scrollbar-thumb { background: #3a4050; }
      html.dark .activity-item::before { background: #3a4050; }
      html.dark .activity-dot { border-color: #1e2128; }

      /* Floating settings button */
      .settings-fab {
        background: #e4ddd3;
        border: 1px solid #ccc6bc;
        color: #6b7280;
        transition: all 0.2s ease;
        cursor: pointer;
      }
      .settings-fab:hover {
        background: #d8d0c6;
        color: #374151;
        transform: scale(1.05);
      }
      html.dark .settings-fab {
        background: #1a1d23;
        border-color: #32363f;
        color: #9ca3af;
      }
      html.dark .settings-fab:hover {
        background: #22252d;
        color: #e5e7eb;
      }
      /* Settings panel */
      .settings-panel {
        background: #f5f0e8;
        border: 1px solid #d5cfc6;
      }
      html.dark .settings-panel {
        background: #252830;
        border-color: #3a4050;
      }
      html.dark .settings-panel-title { color: #f3f4f6; }
      html.dark .settings-section-label { color: #9ca3af; }
      html.dark .settings-section-hint { color: #6b7280; }
      /* Overlay style option boxes */
      .overlay-style-option {
        border: 2px solid #d5cfc6;
        color: #6b7280;
        transition: all 0.15s ease;
        cursor: pointer;
        background: transparent;
      }
      .overlay-style-option:hover {
        border-color: #d4976a;
        color: #d4976a;
        background: rgba(212, 151, 106, 0.05);
      }
      .overlay-style-option.active {
        border-color: #d4976a;
        color: #d4976a;
        background: rgba(212, 151, 106, 0.1);
      }
      html.dark .overlay-style-option { border-color: #3a4050; color: #9ca3af; }
      html.dark .overlay-style-option:hover { border-color: #d4976a; color: #d4976a; }
      html.dark .overlay-style-option.active { border-color: #d4976a; color: #d4976a; background: rgba(212,151,106,0.15); }
      /* Theme style option boxes (same visual style as overlay-style-option) */
      .theme-style-option {
        border: 2px solid #d5cfc6;
        color: #6b7280;
        transition: all 0.15s ease;
        cursor: pointer;
        background: transparent;
      }
      .theme-style-option:hover {
        border-color: #d4976a;
        color: #d4976a;
        background: rgba(212, 151, 106, 0.05);
      }
      .theme-style-option.active {
        border-color: #d4976a;
        color: #d4976a;
        background: rgba(212, 151, 106, 0.1);
      }
      html.dark .theme-style-option { border-color: #3a4050; color: #9ca3af; }
      html.dark .theme-style-option:hover { border-color: #d4976a; color: #d4976a; }
      html.dark .theme-style-option.active { border-color: #d4976a; color: #d4976a; background: rgba(212,151,106,0.15); }
    </style>
  </head>

  <body class="bg-surface font-sans text-gray-800 text-sm antialiased">
    <%# Progress bar — shown during navigation %>
    <up-progress-bar></up-progress-bar>

    <%# Flash messages — up-hungry keeps them updated across fragment swaps %>
    <%= render 'shared/flash' %>

    <%# Two-panel shell — full height, no top nav bar for maximum space %>
    <div class="app-shell">
      <%= yield %>
    </div>

    <%# Floating settings button + panel %>
    <button id="settings-fab"
            class="settings-fab fixed bottom-6 right-6 z-40 w-11 h-11 rounded-full shadow-xl flex items-center justify-center"
            title="Settings"
            onclick="toggleSettingsPanel(event)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      </svg>
    </button>

    <div id="settings-panel"
         class="settings-panel hidden fixed bottom-20 right-6 z-40 w-72 rounded-2xl shadow-2xl p-5">
      <h3 class="settings-panel-title text-sm font-semibold text-gray-900 mb-4">Settings</h3>

      <%# Overlay style selector %>
      <div class="mb-5">
        <p class="settings-section-label text-[10px] font-semibold text-gray-400 uppercase tracking-widest mb-1">Overlay style</p>
        <p class="settings-section-hint text-xs text-gray-400 mb-3">How contacts open for editing</p>
        <div class="grid grid-cols-2 gap-2">
          <button type="button"
                  data-overlay-style="modal"
                  onclick="selectOverlayStyle('modal')"
                  class="overlay-style-option rounded-xl p-3 flex flex-col items-center gap-1.5">
            <%# Modal icon: small centered box %>
            <svg width="28" height="20" viewBox="0 0 28 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="1" y="1" width="26" height="18" rx="2" opacity="0.3"/>
              <rect x="6" y="4" width="16" height="12" rx="1.5"/>
            </svg>
            <span class="text-xs font-medium">Modal</span>
            <span class="text-[10px] text-gray-400 text-center leading-tight">Centered dialog</span>
          </button>
          <button type="button"
                  data-overlay-style="drawer"
                  onclick="selectOverlayStyle('drawer')"
                  class="overlay-style-option rounded-xl p-3 flex flex-col items-center gap-1.5">
            <%# Drawer icon: panel from right %>
            <svg width="28" height="20" viewBox="0 0 28 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="1" y="1" width="26" height="18" rx="2" opacity="0.3"/>
              <rect x="15" y="1" width="12" height="18" rx="0" style="stroke-width:0" fill="currentColor" opacity="0.3"/>
              <line x1="15" y1="1" x2="15" y2="19"/>
            </svg>
            <span class="text-xs font-medium">Drawer</span>
            <span class="text-[10px] text-gray-400 text-center leading-tight">Side panel</span>
          </button>
        </div>
      </div>

      <%# Theme selector: Light / Dark / System %>
      <div>
        <p class="settings-section-label text-[10px] font-semibold text-gray-400 uppercase tracking-widest mb-1">Appearance</p>
        <p class="settings-section-hint text-xs text-gray-400 mb-3">Color theme preference</p>
        <div class="grid grid-cols-3 gap-2">
          <button type="button" data-theme="light" onclick="selectTheme('light')"
                  class="theme-style-option rounded-xl p-2.5 flex flex-col items-center gap-1.5">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
            <span class="text-[10px] font-medium">Light</span>
          </button>
          <button type="button" data-theme="dark" onclick="selectTheme('dark')"
                  class="theme-style-option rounded-xl p-2.5 flex flex-col items-center gap-1.5">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            <span class="text-[10px] font-medium">Dark</span>
          </button>
          <button type="button" data-theme="system" onclick="selectTheme('system')"
                  class="theme-style-option rounded-xl p-2.5 flex flex-col items-center gap-1.5">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
            <span class="text-[10px] font-medium">System</span>
          </button>
        </div>
      </div>
    </div>

    <script>
      // Settings panel toggle
      window.toggleSettingsPanel = function(e) {
        e.stopPropagation();
        document.getElementById('settings-panel').classList.toggle('hidden');
      };
      // Close on outside click
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#settings-fab') && !e.target.closest('#settings-panel')) {
          var panel = document.getElementById('settings-panel');
          if (panel) panel.classList.add('hidden');
        }
      });

      // Overlay style selector
      window.selectOverlayStyle = function(style) {
        localStorage.setItem('overlayStyle', style);
        document.querySelectorAll('[data-overlay-link]').forEach(function(el) {
          el.setAttribute('up-layer', 'new ' + style);
          if (style === 'drawer') {
            el.setAttribute('up-size', 'grow');
            el.setAttribute('up-position', 'right');
          } else {
            el.removeAttribute('up-size');
            el.removeAttribute('up-position');
          }
        });
        document.querySelectorAll('.overlay-style-option').forEach(function(btn) {
          btn.classList.toggle('active', btn.dataset.overlayStyle === style);
        });
      };

      // Theme: light / dark / system
      function applyTheme(theme) {
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else if (theme === 'light') {
          document.documentElement.classList.remove('dark');
        } else {
          // system
          if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        }
      }
      window.selectTheme = function(theme) {
        localStorage.setItem('theme', theme);
        applyTheme(theme);
        document.querySelectorAll('.theme-style-option').forEach(function(btn) {
          btn.classList.toggle('active', btn.dataset.theme === theme);
        });
      };
      // Follow system preference changes when theme is 'system'
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
        if ((localStorage.getItem('theme') || 'system') === 'system') {
          applyTheme('system');
        }
      });

      // Initialize settings buttons on page load
      document.addEventListener('DOMContentLoaded', function() {
        selectOverlayStyle(localStorage.getItem('overlayStyle') || 'modal');
        selectTheme(localStorage.getItem('theme') || 'system');
      });
    </script>
  </body>
</html>
